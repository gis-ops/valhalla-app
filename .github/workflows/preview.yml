name: PR preview

on:
  pull_request:
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - '.env'
      - 'jsconfig.json'
      
env:
  PULL_NUMBER: ${{ github.event.pull_request.number }}

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: 🌐 Update homepage URL
        run: |
          NEW_HOMEPAGE="https://valhalla.openstreetmap.de/$PULL_NUMBER"
          jq --arg homepage "$NEW_HOMEPAGE" '. + {homepage: $homepage}' package.json > tmp.json
          mv tmp.json package.json
      - uses: actions/setup-node@v2
        with:
          node-version: '16.x'
      - name: 🔧 Create build
        run: |
          npm install
          npm run build
      - name: 🚀 Preview deployment
        run: |
          eval $(ssh-agent -s)
          ssh-add - <<< "${{ secrets.SSH_PRIVATE_KEY }}"
          rsync -r --delete --rsync-path="mkdir -p ${{ vars.HOST_TARGET_DIR }}/$PULL_NUMBER && rsync" -e "ssh -p 23432 -o StrictHostKeyChecking=no" ./build/ ${{ vars.HOST_USERNAME }}@${{ vars.HOST_IP }}:${{ vars.HOST_TARGET_DIR }}/$PULL_NUMBER
